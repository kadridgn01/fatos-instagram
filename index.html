<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Akış</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#12151c">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="assets/icon-192.png">

<style>
:root{
  --bg:#0f1115; --paper:#12151c; --ink:#e7e9ee; --muted:#9aa3af;
  --accent:#5da9ff; --border:#1f2330; --soft:#181c25; --radius:14px;
  --maxw:600px; --topbar-h:64px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);
  font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",sans-serif}
body{
  padding-top: calc(var(--topbar-h) + env(safe-area-inset-top));
  padding-bottom: calc(90px + env(safe-area-inset-bottom));
}
.page{ display: none; } .page.active{ display: block; }
.topbar{ position:fixed; inset:0 0 auto 0; z-index:50; height: calc(var(--topbar-h) + env(safe-area-inset-top)); padding-top: env(safe-area-inset-top); background:#0e121b; border-bottom:1px solid var(--border); display:flex; align-items:flex-end; }
.row{max-width:var(--maxw); height:var(--topbar-h); margin:0 auto; width:100%; display:flex; align-items:center; justify-content:center; padding:0 16px; position:relative;}
.topbar-back{ display: none; cursor: pointer; font-size: 16px; font-weight: 600; position: absolute; left: 16px; top: 50%; transform: translateY(-50%); }
.topbar-back.visible{ display: block; }
.brand{display:flex; align-items:center; gap:10px; font-weight:800; font-size:20px;}
.brand.centered{ position: absolute; left: 50%; transform: translateX(-50%); }
.logo{height:28px}
.stories{ max-width:var(--maxw); margin:0 auto; padding:10px 12px; display:flex; gap:12px; overflow-x:auto; scrollbar-width:none; -webkit-overflow-scrolling:touch; }
.stories::-webkit-scrollbar{display:none}
.story-chip{ flex:0 0 auto; width:74px; text-align:center; font-size:12px; color:var(--muted); background:transparent; border:0; padding:0; outline:none; cursor:pointer; }
.story-chip.me .story-ring{ background: transparent; position: relative; }
.story-chip.me .story-ring::after{ content: '+'; position: absolute; bottom: -2px; right: 0; background-color: var(--accent); color: white; width: 22px; height: 22px; border-radius: 50%; display: grid; place-items: center; font-size: 16px; border: 2px solid var(--paper); }
.story-ring{ width:68px; height:68px; padding:2px; border-radius:50%; background: conic-gradient(from 0deg, #6ab0ff, #a873ff, #6ab0ff); display:grid; place-items:center; }
.story-avatar{ width:64px; height:64px; border-radius:50%; object-fit:cover; border:0; }
.story-name{margin-top:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
.feed{max-width:var(--maxw); margin:0 auto; padding:0 12px 16px; display:flex; flex-direction:column; gap:16px}
.card{background:var(--paper); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden}
.card .head{display:flex; align-items:center; gap:10px; padding:10px}
.card .head img{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--soft)}
.card .head .user{font-weight:600}
.card .media{width:100%; display:block; height:auto;}
.card .actions{display:flex; gap:10px; padding:10px 12px; font-size: 22px;}
.card .actions .icon{cursor:pointer;}
.search-page{ max-width: var(--maxw); margin: 0 auto; padding: 16px; }
.search-bar{ width: 100%; padding: 12px 16px; font-size: 16px; background-color: var(--soft); border: 1px solid var(--border); border-radius: var(--radius); color: var(--ink); outline: none; }
.search-results{ margin-top: 20px; display: flex; flex-direction: column; gap: 12px; }
.result-item{ display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 10px; cursor: pointer; }
.result-item:hover{ background-color: var(--soft); }
.result-item img{ width: 44px; height: 44px; border-radius: 50%; object-fit: cover; }
.profile-page{ max-width: var(--maxw); margin: 0 auto; padding: 24px 16px; }
.profile-header{ display: flex; align-items: center; gap: 20px; padding-bottom: 24px; border-bottom: 1px solid var(--border); margin-bottom: 24px;}
.profile-avatar-wrapper{ position: relative; cursor: pointer; width: 100px; height: 100px; flex-shrink: 0; }
.profile-avatar{ width: 100px; height: 100px; border-radius: 50%; object-fit: cover; box-sizing: border-box; }
.profile-avatar-wrapper.has-story .profile-avatar{ padding: 4px; background: var(--paper); }
.profile-avatar-wrapper.has-story::before{ content: ''; position: absolute; inset: 0; border-radius: 50%; padding: 2px; background: conic-gradient(from 0deg, #6ab0ff, #a873ff, #6ab0ff); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; }
.profile-details{ flex: 1; display: flex; flex-direction: column; gap: 4px;}
.profile-details .full-name{ font-size: 22px; font-weight: 800; margin: 0; }
.profile-details .username{ font-size: 15px; color: var(--muted); }
.profile-details .stats{ margin-top: 8px; color: var(--muted); font-size: 14px;}
.profile-details .stats strong{ color: var(--ink); font-weight: 700; }
.profile-details .bio{ margin-top: 4px; font-size: 14px; }
.profile-actions{ display: flex; gap: 8px; }
.btn{ border:0; padding: 8px 16px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 14px; }
.btn-primary{ background-color: var(--accent); color: white; }
.btn-secondary{ background-color: var(--soft); color: var(--ink); }
.post-grid{ display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
.grid-item{ cursor: pointer; }
.grid-item img{ width: 100%; height: 100%; object-fit: cover; aspect-ratio: 1 / 1; }
.bottombar{ position:fixed; left:10px; right:10px; bottom: calc(env(safe-area-inset-bottom) + 8px); height:58px; background:var(--paper); border:1px solid var(--border); border-radius:14px; display:flex; justify-content:space-around; align-items:center; z-index:30; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
.nav-item{cursor:pointer; display:flex; flex-direction:column; align-items:center; font-size:20px; background:none; border:none; color:inherit;}
.nav-item span{font-size:12px; color:var(--muted); margin-top:2px}
.nav-item.active span{color:var(--ink); font-weight: 600;}
.viewer{ position: fixed; inset: 0; z-index: 100; display:none; background:#000; padding:0; }
.viewer.active{display:block}
.viewer-inner{ position: relative; height: 100%; }
.viewer-stage{ position: absolute; inset: 0; height: 100svh; overflow:hidden; display:grid; place-items:center; }
.story-media{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; background:#000; }
.tapzone{ position:absolute; top:0; bottom:0; width:50%; }
.tapzone.left{left:0} .tapzone.right{right:0}
.viewer-top{ top:0; padding:10px 12px; padding-top: calc(10px + env(safe-area-inset-top, 0px)); background: linear-gradient(180deg, rgba(0,0,0,.55), transparent); display:flex; flex-direction:column; gap:6px; position:absolute; left:0; right:0; z-index:2; pointer-events:none; }
.viewer-top * { pointer-events:auto; }
.progress{ position:relative; display:flex; gap:6px; height:3px; }
.seg{ flex:1; height:3px; background:rgba(255,255,255,.25); border-radius:2px; overflow:hidden; }
.seg > i{ display:block; height:100%; width:0%; background:#fff; transition:width .2s linear; }
.viewer-meta{ display:flex; align-items:center; gap:10px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.4); margin-top:4px; }
.viewer-meta img{ width:40px; height:40px; border-radius:50%; border:2px solid rgba(255,255,255,.35); object-fit:cover; }
.viewer-close{ appearance:none; border:0; cursor:pointer; background:rgba(0,0,0,.35); color:#fff; padding:8px 10px; border-radius:10px; font-weight:700; margin-left:auto; }
</style>
</head>
<body>

<div class="topbar" role="banner">
    <div class="row">
        <div id="topbarBack" class="topbar-back">‹ Geri</div>
        <div class="brand centered" id="brandContainer">
            <img src="assets/logo.png" class="logo" alt="logo" id="brandLogo">
            <span id="brandTitle">Akış</span>
        </div>
    </div>
</div>

<main id="homePage" class="page"></main>
<main id="searchPage" class="page"></main>
<main id="profilePage" class="page"></main>
<main id="postFeedPage" class="page feed"></main>

<nav class="bottombar">
    <button class="nav-item" id="navHome">🏠<span>Ana Sayfa</span></button>
    <button class="nav-item" id="navSearch">🔍<span>Arama</span></button>
    <button class="nav-item" id="navProfile">👤<span>Profil</span></button>
</nav>

<div class="viewer" id="viewer" aria-hidden="true">
    <div class="viewer-inner">
        <div class="viewer-top">
            <div class="progress" id="progress"></div>
            <div class="viewer-meta">
                <img id="vAvatar" src="" alt="">
                <div id="vName"></div>
                <button class="viewer-close" id="btnClose">✕</button>
            </div>
        </div>
        <div class="viewer-stage" id="viewerStage"></div>
        <div class="tapzone left" id="tapLeft"></div>
        <div class="tapzone right" id="tapRight"></div>
    </div>
</div>

<script>
// --- VERİTABANI ---
const USERS_DB = [
    { id: "peri", username: "peri", name: "Peri", avatar: "assets/peri-avatar.jpg", bio: "Hayallerimin peşindeyim...", stats: { posts: 3, friends: 150 }, segments: [], posts: Array.from({length: 3}, (_, i) => ({ img: `assets/peri-post-${i + 1}.jpg`})), following: ["dursunyilmaz"] },
    { id: "macari_fatos", username: "macari_fatos", name: "Fatoş Maçari", avatar: "assets/fatos-avatar.jpg", bio: "...", stats: { posts: 12, friends: "18.4B" }, segments: [ { sources: ["assets/fatos-story-1.mp4"], dur: 10 }, { sources: ["assets/green.jpg"], dur: 5 } ], posts: Array.from({length: 12}, (_, i) => ({ img: `assets/fatos-post-${i + 1}.jpg`})) },
    { id: "dursunyilmaz", username: "yilmazdursun5353", name: "Dursun Yılmaz", avatar: "assets/dursun-avatar.jpg", bio: "...", stats: { posts: 15, friends: 128 }, segments: [ { sources: ["assets/dursun-story-1.mp4"], dur: 8 }], posts: Array.from({length: 15}, (_, i) => ({ img: `assets/dursun-post-${i + 1}.jpg`})) }
];

// --- ANA SAYFA MANTIĞI (STALKLAMA) ---
const periUser = USERS_DB.find(u => u.id === 'peri');
const followedUsers = USERS_DB.filter(u => periUser.following.includes(u.id));
const STORIES_DB = followedUsers.filter(u => u.segments.length > 0);
const FEED_DB = followedUsers.map(user => ({ user: user, post: user.posts[0] })).filter(p => p.post);

// --- DOM ELEMENTLERİ ---
const brandTitle = document.getElementById('brandTitle');
const brandLogo = document.getElementById('brandLogo');
const brandContainer = document.getElementById('brandContainer');
const allPages = document.querySelectorAll('.page');
const navHome = document.getElementById('navHome');
const navSearch = document.getElementById('navSearch');
const navProfile = document.getElementById('navProfile');
const viewer = document.getElementById('viewer');
const progress = document.getElementById('progress');
const vName = document.getElementById('vName');
const vAvatar = document.getElementById('vAvatar');
const btnClose = document.getElementById('btnClose');
const tapLeft = document.getElementById('tapLeft');
const tapRight = document.getElementById('tapRight');
const viewerStage = document.getElementById('viewerStage');
const topbarBack = document.getElementById('topbarBack');
let lastProfileId = null;

// --- RENDER FONKSİYONLARI ---
function renderHomePage() {
    const homePage = document.getElementById('homePage');
    homePage.innerHTML = `<section class="stories"></section><section class="feed"></section>`;
    const storiesContainer = homePage.querySelector('.stories');
    const feedContainer = homePage.querySelector('.feed');
    const periChip = document.createElement('button');
    periChip.className = 'story-chip me';
    periChip.innerHTML = `<div class="story-ring"><img class="story-avatar" src="${periUser.avatar}" alt="${periUser.name}"></div><div class="story-name">Hikayen</div>`;
    periChip.onclick = () => alert('Kendi hikayeni ekle (simülasyon)');
    storiesContainer.appendChild(periChip);
    STORIES_DB.forEach(s => {
        const chip = document.createElement('button');
        chip.className = 'story-chip';
        chip.innerHTML = `<div class="story-ring"><img class="story-avatar" src="${s.avatar}" alt="${s.name}"></div><div class="story-name">${s.name}</div>`;
        chip.onclick = () => openViewer(STORIES_DB, s.id);
        storiesContainer.appendChild(chip);
    });
    FEED_DB.forEach(p => {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `<div class="head"><img src="${p.user.avatar}" alt="${p.user.username}"><div class="user">${p.user.username}</div></div><img class="media" src="${p.post.img}" alt=""><div class="actions"><span class="icon">❤️</span><span class="icon">💬</span><span class="icon">↗️</span></div>`;
        feedContainer.appendChild(card);
    });
}
function renderProfile(userId) {
    const profilePage = document.getElementById('profilePage');
    profilePage.innerHTML = `
        <div class="profile-page">
            <header class="profile-header">
                <div id="profileAvatarWrapper" class="profile-avatar-wrapper">
                    <img id="profileAvatar" class="profile-avatar" src="" alt="Profil avatarı">
                </div>
                <div class="profile-details">
                    <h2 id="profileFullName" class="full-name"></h2>
                    <div id="profileUsername" class="username"></div>
                    <div id="profileStats" class="stats"></div>
                    <div id="profileBio" class="bio"></div>
                </div>
                <div id="profileActions" class="profile-actions">
                    <button class="btn btn-primary">Arkadaş ekle</button>
                    <button class="btn btn-secondary">Mesaj</button>
                </div>
            </header>
            <section id="postGrid" class="post-grid"></section>
        </div>`;
    const user = USERS_DB.find(u => u.id === userId);
    if (!user) return;
    document.getElementById('profileAvatar').src = user.avatar;
    document.getElementById('profileFullName').textContent = user.name;
    document.getElementById('profileUsername').textContent = `@${user.username}`;
    document.getElementById('profileBio').textContent = user.bio;
    document.getElementById('profileStats').innerHTML = `<strong>${user.stats.posts}</strong> gönderi  ·  <strong>${user.stats.friends}</strong> arkadaş`;
    document.getElementById('profileActions').style.display = (userId === 'peri') ? 'none' : 'flex';
    const avatarWrapper = document.getElementById('profileAvatarWrapper');
    if (user.segments && user.segments.length > 0) {
        avatarWrapper.classList.add('has-story');
        avatarWrapper.onclick = () => openViewer(USERS_DB, user.id);
    } else {
        avatarWrapper.classList.remove('has-story');
        avatarWrapper.onclick = null;
    }
    const gridContainer = document.getElementById('postGrid');
    user.posts.forEach((post, index) => {
        const gridItem = document.createElement('div');
        gridItem.className = 'grid-item';
        gridItem.innerHTML = `<img src="${post.img}" alt="Gönderi ${index+1}">`;
        gridItem.onclick = () => navigateToPostFeed(user.id, index);
        gridContainer.appendChild(gridItem);
    });
}
function renderSearchResults(query) {
    const searchResults = document.getElementById('searchResults');
    const normalizedQuery = query.toLowerCase().trim();
    if (normalizedQuery.length < 2) { searchResults.innerHTML = ''; return; }
    const results = USERS_DB.filter(u => (u.name.toLowerCase().includes(normalizedQuery) || u.username.toLowerCase().includes(normalizedQuery)) && u.id !== 'peri');
    searchResults.innerHTML = '';
    results.forEach(user => {
        const item = document.createElement('div');
        item.className = 'result-item';
        item.innerHTML = `<img src="${user.avatar}" alt="${user.name}"><div class="names"><div class="name">${user.name}</div></div>`;
        item.onclick = () => navigateToProfile(user.id);
        searchResults.appendChild(item);
    });
}

// --- HİKAYE İZLEYİCİ ---
let storyDataSource = [], currentSourceIndex = 0, currentSegmentIndex = 0, timerId = null;
function openViewer(source, startId) { storyDataSource = source; currentSourceIndex = Math.max(0, source.findIndex(s => s.id === startId)); currentSegmentIndex = 0; viewer.classList.add('active'); document.documentElement.style.overflow = 'hidden'; loadCurrentSegment(); }
function closeViewer() { viewer.classList.remove('active'); document.documentElement.style.overflow = ''; clearTimer(); const videoEl = viewerStage.querySelector('video'); if (videoEl) videoEl.pause(); }
async function loadCurrentSegment() { const user = storyDataSource[currentSourceIndex]; const segment = user.segments[currentSegmentIndex]; if (!user || !segment) { closeViewer(); return; } vName.textContent = user.name; vAvatar.src = user.avatar; renderProgress(user.segments.length, currentSegmentIndex); clearTimer(); viewerStage.innerHTML = ''; const sourceUrl = segment.sources[0]; const isImage = sourceUrl.match(/\.(jpeg|jpg|png|gif|webp)$/); if (isImage) { const img = document.createElement('img'); img.src = sourceUrl; img.className = 'story-media'; viewerStage.appendChild(img); startTimer((segment.dur || 7) * 1000); } else { const video = document.createElement('video'); video.className = 'story-media'; video.playsInline = true; video.webkitPlaysInline = true; video.muted = true; video.preload = 'metadata'; video.src = sourceUrl; video.addEventListener('ended', nextSegment); viewerStage.appendChild(video); try { await video.play(); startTimer((segment.dur || video.duration)*1000); } catch (e) { nextSegment(); } } }
function renderProgress(total, activeIndex) { progress.innerHTML = ''; for (let i = 0; i < total; i++) { const seg = document.createElement('div'); seg.className = 'seg'; seg.innerHTML = `<i style="width:${i < activeIndex ? 100 : 0}%"></i>`; progress.appendChild(seg); } }
function startTimer(ms) { const start = performance.now(); const segBar = progress.children[currentSegmentIndex]?.firstElementChild; if (!segBar) return; function tick(now) { const pct = Math.min(100, ((now - start) / ms) * 100); segBar.style.width = pct + '%'; if (pct >= 100) { nextSegment(); return; } timerId = requestAnimationFrame(tick); } timerId = requestAnimationFrame(tick); }
function clearTimer() { if (timerId) cancelAnimationFrame(timerId); timerId = null; }
function nextSegment() { const user = storyDataSource[currentSourceIndex]; if (currentSegmentIndex < user.segments.length - 1) { currentSegmentIndex++; loadCurrentSegment(); } else { nextStory(); } }
function prevSegment() { if (currentSegmentIndex > 0) { currentSegmentIndex--; loadCurrentSegment(); } else { prevStory(); } }
function nextStory() { if (currentSourceIndex < storyDataSource.length - 1) { currentSourceIndex++; currentSegmentIndex = 0; loadCurrentSegment(); } else { closeViewer(); } }
function prevStory() { if (currentSourceIndex > 0) { currentSourceIndex--; currentSegmentIndex = 0; loadCurrentSegment(); } }
btnClose.onclick = closeViewer;
tapRight.addEventListener('click', nextSegment);
tapLeft.addEventListener('click', prevSegment);

// --- DİKEY GÖNDERİ AKIŞI ---
function navigateToPostFeed(userId, startIndex) {
    lastProfileId = userId;
    const user = USERS_DB.find(u => u.id === userId);
    if (!user) return;
    const postFeedPage = document.getElementById('postFeedPage');
    postFeedPage.innerHTML = '';
    user.posts.forEach((post, index) => {
        const card = document.createElement('article');
        card.className = 'card';
        card.id = `post-feed-${index}`;
        card.innerHTML = `<div class="head"><img src="${user.avatar}" alt="${user.username}"><div class="user">${user.username}</div></div><img class="media" src="${post.img}" alt=""><div class="actions"><span class="icon">❤️</span><span class="icon">💬</span><span class="icon">↗️</span></div>`;
        postFeedPage.appendChild(card);
    });
    showPage('postFeedPage');
    setTimeout(() => { document.getElementById(`post-feed-${startIndex}`).scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
}

// --- NAVİGASYON ---
function showPage(pageId) {
    allPages.forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    const isSubPage = pageId === 'postFeedPage';
    topbarBack.classList.toggle('visible', isSubPage);
    brandLogo.style.display = isSubPage ? 'none' : 'block';
    brandContainer.classList.toggle('centered', !isSubPage);
    let activeNav = null;
    let newTitle = brandTitle.textContent;
    if(pageId === 'homePage') {
        activeNav = navHome;
        newTitle = 'Akış';
    } else if(pageId === 'searchPage') {
        activeNav = navSearch;
        newTitle = 'Arama';
    } else if(pageId === 'profilePage') {
        const currentProfileUser = USERS_DB.find(u => u.username === brandTitle.textContent);
        activeNav = (currentProfileUser && currentProfileUser.id === 'peri') ? navProfile : navSearch;
    } else if (pageId === 'postFeedPage') {
        activeNav = (lastProfileId === 'peri') ? navProfile : navSearch;
        newTitle = 'Gönderiler';
    }
    if(activeNav) activeNav.classList.add('active');
    brandTitle.textContent = newTitle;
}
function navigateToProfile(userId) {
    renderProfile(userId);
    const user = USERS_DB.find(u => u.id === userId);
    if (!user) return;
    brandTitle.textContent = user.username;
    showPage('profilePage');
}
navHome.onclick = () => showPage('homePage');
navSearch.onclick = () => showPage('searchPage');
navProfile.onclick = () => navigateToProfile('peri');
topbarBack.onclick = () => { if(lastProfileId) navigateToProfile(lastProfileId); };
const searchInput = document.getElementById('searchInput');
let searchTimer;
searchInput.oninput = () => { clearTimeout(searchTimer); searchTimer = setTimeout(() => { renderSearchResults(searchInput.value); }, 400); };

// --- İLK YÜKLEME ---
document.addEventListener('DOMContentLoaded', () => {
    renderHomePage();
    showPage('homePage');
});
</script>
</body>
</html>
