<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Akış</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#12151c">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="assets/icon-192.png">

<style>
:root{
  --bg:#0f1115; --paper:#12151c; --ink:#e7e9ee; --muted:#9aa3af;
  --accent:#5da9ff; --border:#1f2330; --soft:#181c25; --radius:14px;
  --maxw:600px; --topbar-h:64px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);
  font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",sans-serif}
body{
  padding-top: calc(var(--topbar-h) + env(safe-area-inset-top));
  padding-bottom: calc(90px + env(safe-area-inset-bottom));
}
.page{ display: none; } .page.active{ display: block; }
.topbar{ position:fixed; inset:0 0 auto 0; z-index:50; height: calc(var(--topbar-h) + env(safe-area-inset-top)); padding-top: env(safe-area-inset-top); background:#0e121b; border-bottom:1px solid var(--border); display:flex; align-items:flex-end; }
.row{max-width:var(--maxw); height:var(--topbar-h); margin:0 auto; width:100%; display:flex; align-items:center; justify-content:space-between; padding:0 16px;}
.brand{display:flex; align-items:center; gap:10px; font-weight:800; font-size:20px;}
.logo{height:28px}
.back-btn{ display:none; margin-right:8px; height:36px; min-width:36px; border-radius:10px; border:1px solid var(--border); background:var(--soft); color:var(--ink); font-weight:800; cursor:pointer; }
.back-btn.show{ display:inline-flex; align-items:center; justify-content:center; }
.stories{ max-width:var(--maxw); margin:0 auto; padding:10px 12px; display:flex; gap:12px; overflow-x:auto; scrollbar-width:none; -webkit-overflow-scrolling:touch; }
.stories::-webkit-scrollbar{display:none}
.story-chip{ flex:0 0 auto; width:74px; text-align:center; font-size:12px; color:var(--muted); background:transparent; border:0; padding:0; outline:none; cursor:pointer; }
.story-ring{ width:68px; height:68px; padding:2px; border-radius:50%; background: conic-gradient(from 0deg, #6ab0ff, #a873ff, #6ab0ff); display:grid; place-items:center; }
.story-avatar{ width:64px; height:64px; border-radius:50%; object-fit:cover; border:0; }
.story-name{margin-top:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
.feed{max-width:var(--maxw); margin:0 auto; padding:0 12px 16px; display:flex; flex-direction:column; gap:16px}
.card{background:var(--paper); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden}
.card .head{display:flex; align-items:center; gap:10px; padding:10px}
.card .head img{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--soft)}
.card .head .user{font-weight:600}
.card .media{width:100%; display:block; height:auto;}
.card .actions{display:flex; gap:10px; padding:10px 12px; font-size: 22px;}
.card .actions .icon{cursor:pointer;}

/* --- Search --- */
.search-page{ max-width: var(--maxw); margin: 0 auto; padding: 16px; }
.search-bar{ width: 100%; padding: 12px 16px; font-size: 16px; background-color: var(--soft); border: 1px solid var(--border); border-radius: var(--radius); color: var(--ink); outline: none; }
.search-results{ margin-top: 20px; display: flex; flex-direction: column; gap: 12px; }
.result-item{ display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 10px; cursor: pointer; }
.result-item:hover{ background-color: var(--soft); }
.result-item img{ width: 44px; height: 44px; border-radius: 50%; object-fit: cover; }

/* --- Profile --- */
.profile-page{ max-width: var(--maxw); margin: 0 auto; padding: 16px; }
.profile-card{ background: var(--paper); border:1px solid var(--border); border-radius: var(--radius); padding:16px; margin-bottom:12px; }
.profile-header{ display:flex; align-items:center; gap:16px; }
.profile-avatar-wrapper{ position: relative; cursor: pointer; width: 70px; height: 70px; flex:0 0 auto; }
.profile-avatar-wrapper.has-story .profile-avatar{ padding: 3px; background: var(--paper); }
.profile-avatar-wrapper.has-story::before{ content: ''; position: absolute; inset: 0; border-radius: 50%; padding: 2px; background: conic-gradient(from 0deg, #6ab0ff, #a873ff, #6ab0ff); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; }
.profile-avatar{ width: 70px; height: 70px; border-radius: 50%; object-fit: cover; box-sizing: border-box; }
.profile-content{ flex:1; min-width:0; }
.profile-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.profile-title{ display:flex; flex-direction:column; min-width:0; }
.display-name{ font-size:22px; font-weight:800; line-height:1.1; }
.handle{ color:var(--muted); font-size:14px; margin-top:2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.profile-cta{ display:flex; gap:8px; flex:0 0 auto; }
.btn{ appearance:none; border:1px solid var(--border); background:var(--soft); color:var(--ink); border-radius:9999px; padding:10px 14px; font-weight:700; cursor:pointer; }
.btn.primary{ background:var(--accent); border-color:transparent; color:#0b0f17; }
.btn.ghost{ background:rgba(255,255,255,.06); }
.profile-bio{ white-space:pre-wrap; margin-top:10px; font-size:14px; color:var(--ink); }
.profile-counts{ margin-top:10px; font-size:14px; color:var(--muted); }
.profile-counts b{ color:var(--ink); font-weight:800; }
.post-grid{ display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
.grid-item{ cursor: pointer; }
.grid-item img{ width: 100%; height: 100%; object-fit: cover; aspect-ratio: 1 / 1; }

/* --- Bottom bar --- */
.bottombar{ position:fixed; left:10px; right:10px; bottom: calc(env(safe-area-inset-bottom) + 8px); height:58px; background:var(--paper); border:1px solid var(--border); border-radius:14px; display:flex; justify-content:space-around; align-items:center; z-index:30; box-shadow: 0 10px 30px rgba(0,0,0,.35); gap:0; }
.nav-item{ flex:1; position:relative; cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:20px; padding:6px 0; margin:0; appearance:none; -webkit-appearance:none; background:transparent; border:0; box-shadow:none; color:var(--ink); }
.nav-item span{font-size:12px; color:var(--muted); margin-top:2px}
.nav-item.active span{color:var(--ink); font-weight: 600;}
.nav-item:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; border-radius:10px; }
/* aktif göstergesi: alt noktacık, ayrı buton hissi yok */
.nav-item.active::after{ content:""; position:absolute; bottom:6px; width:6px; height:6px; border-radius:50%; background:var(--accent); }

/* --- Viewer --- */
.viewer{ position: fixed; inset: 0; z-index: 100; display:none; background:#000; padding:0; }
.viewer.active{display:block}
.viewer-inner{ position: relative; height: 100%; }
.viewer-stage{ position: absolute; inset: 0; height: 100svh; overflow:hidden; display:grid; place-items:center; }
.story-media{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; background:#000; }
.tapzone{ position:absolute; top:0; bottom:0; width:50%; }
.tapzone.left{left:0} .tapzone.right{right:0}
.viewer-top{ top:0; padding:10px 12px; padding-top: calc(10px + env(safe-area-inset-top, 0px)); background: linear-gradient(180deg, rgba(0,0,0,.55), transparent); display:flex; flex-direction:column; gap:6px; position:absolute; left:0; right:0; z-index:2; pointer-events:none; }
.viewer-top * { pointer-events:auto; }
.progress{ position:relative; display:flex; gap:6px; height:3px; }
.seg{ flex:1; height:3px; background:rgba(255,255,255,.25); border-radius:2px; overflow:hidden; }
.seg > i{ display:block; height:100%; width:0%; background:#fff; transition:width .2s linear; }
.viewer-meta{ display:flex; align-items:center; gap:10px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.4); margin-top:4px; }
.viewer-meta img{ width:40px; height:40px; border-radius:50%; border:2px solid rgba(255,255,255,.35); object-fit:cover; }
.viewer-close{ appearance:none; border:0; cursor:pointer; background:rgba(0,0,0,.35); color:#fff; padding:8px 10px; border-radius:10px; font-weight:700; margin-left:auto; }
</style>
</head>
<body>

<div class="topbar" role="banner">
  <div class="row">
    <button id="btnBack" class="back-btn" aria-label="Geri">←</button>
    <div class="brand" aria-label="Marka">
      <img src="assets/logo.png" class="logo" alt="logo">
      <span id="brandTitle">Akış</span>
    </div>
  </div>
</div>

<!-- SAYFALAR -->
<main id="homePage" class="page" aria-label="Ana sayfa"></main>

<main id="searchPage" class="page search-page" aria-label="Arama">
  <!-- FIX: Eksik olan arama input ve sonuç listesi eklendi -->
  <input id="searchInput" class="search-bar" type="search" placeholder="Kullanıcı ara…" autocomplete="off" aria-label="Kullanıcı ara">
  <div id="searchResults" class="search-results" aria-live="polite"></div>
</main>

<main id="profilePage" class="page profile-page" aria-label="Profil">
  <section class="profile-card">
    <div class="profile-header">
      <div id="profileAvatarWrapper" class="profile-avatar-wrapper">
        <img id="profileAvatar" class="profile-avatar" src="" alt="Profil avatarı">
      </div>
      <div class="profile-content">
        <div class="profile-top">
          <div class="profile-title">
            <div id="profileName" class="display-name"></div>
            <div id="profileHandle" class="handle"></div>
          </div>
          <div class="profile-cta">
            <button id="btnPrimaryProfile" class="btn primary">Takip et</button>
            <button id="btnSecondaryProfile" class="btn ghost">Mesaj</button>
          </div>
        </div>
        <div id="profileBio" class="profile-bio"></div>
        <div id="profileCounts" class="profile-counts"></div>
      </div>
    </div>
  </section>
  <section id="postGrid" class="post-grid" aria-label="Gönderiler"></section>
</main>

<main id="postFeedPage" class="page feed" aria-label="Gönderi akışı"></main>

<!-- ALT GEZİNME -->
<nav class="bottombar" aria-label="Alt gezinti">
  <button class="nav-item" id="navHome" aria-controls="homePage" aria-label="Ana Sayfa">🏠<span>Ana Sayfa</span></button>
  <button class="nav-item" id="navSearch" aria-controls="searchPage" aria-label="Arama">🔍<span>Arama</span></button>
  <button class="nav-item" id="navProfile" aria-controls="profilePage" aria-label="Profil">👤<span>Profil</span></button>
</nav>

<!-- HİKAYE GÖRÜNTÜLEYİCİ -->
<div class="viewer" id="viewer" aria-hidden="true">
  <div class="viewer-inner">
    <div class="viewer-top">
      <div class="progress" id="progress" aria-hidden="true"></div>
      <div class="viewer-meta">
        <img id="vAvatar" src="" alt="">
        <div id="vName"></div>
        <button class="viewer-close" id="btnClose" aria-label="Kapat">✕</button>
      </div>
    </div>
    <div class="viewer-stage" id="viewerStage"></div>
    <div class="tapzone left" id="tapLeft" aria-label="Önceki"></div>
    <div class="tapzone right" id="tapRight" aria-label="Sonraki"></div>
  </div>
</div>

<script>
'use strict';
// --- VERİTABANI ---
const USERS_DB = [
  {
    id: "peri",
    username: "peri",
    name: "Peri",
    avatar: "assets/peri-avatar.jpg",
    bio: "Hayallerimin peşindeyim...",
    stats: { posts: 3, followers: "212", following: 150 },
    segments: [],
    posts: Array.from({length: 3}, (_, i) => ({ img: `assets/peri-post-${i + 1}.jpg`}))
  },
  {
    id: "fatosmacari",
    username: "fatosmacari",
    name: "Fatoş Maçari",
    avatar: "assets/fatos-avatar.jpg",
    bio: "Gezgin ruh ✈️ | Kahve tutkunu ☕ Hayatı dolu dolu yaşa ✨",
    stats: { posts: 12, followers: "18.4B", following: 320 },
    segments: [
      { sources: ["assets/fatos-story-1.mp4"], dur: 10 },
      { sources: ["assets/green.jpg"], dur: 5 }
    ],
    posts: Array.from({length: 12}, (_, i) => ({ img: `assets/fatos-post-${i + 1}.jpg`}))
  },
  {
    id: "selimkaya",
    username: "selimkaya_art",
    name: "Selim Kaya",
    avatar: "assets/selim-avatar.jpg",
    bio: "Dijital Sanatçı | Renklerin peşinde.",
    stats: { posts: 6, followers: "5.2B", following: 150 },
    segments: [ { sources: ["assets/selim-story-1.mp4"], dur: 8 }],
    posts: Array.from({length: 6}, (_, i) => ({ img: `assets/selim-post-${i + 1}.jpg`}))
  },
  {
    id: "kadri",
    username: "kadridgn",
    name: "Kadri Doğan",
    avatar: "assets/kadri-av.jpg",
    bio: "",
    stats: { posts: 1, followers: "1.2K", following: 300 },
    segments: [],
    posts: [ { img: "assets/kadri.jpg" } ]
  },
  {
    id: "okan",
    username: "okanerdemt",
    name: "Okan Erdem",
    avatar: "assets/okan-av.jpg",
    bio: "",
    stats: { posts: 1, followers: "845", following: 210 },
    segments: [],
    posts: [ { img: "assets/okan.jpg" } ]
  }
];

// --- ANA SAYFA ---
// Dinamik akış: Fatoş'u ana sayfadan hariç tut
function getStories(){
  return USERS_DB.filter(u => u.segments.length > 0 && u.id !== 'fatosmacari');
}
function getFeed(){
  const ids = ['kadri','okan'];
  const pick = ids.map(id => USERS_DB.find(u=>u.id===id)).filter(Boolean);
  const out = [];
  pick.forEach(u => {
    if (u.posts && u.posts.length) out.push({ user: u, post: u.posts[0] });
  });
  return out;
}

// --- DOM ELEMENTLERİ ---
const brandTitle = document.getElementById('brandTitle');
const allPages = document.querySelectorAll('.page');
const navHome = document.getElementById('navHome');
const navSearch = document.getElementById('navSearch');
const navProfile = document.getElementById('navProfile');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const viewer = document.getElementById('viewer');
const progress = document.getElementById('progress');
const vName = document.getElementById('vName');
const vAvatar = document.getElementById('vAvatar');
const btnClose = document.getElementById('btnClose');
const tapLeft = document.getElementById('tapLeft');
const tapRight = document.getElementById('tapRight');
const postFeedPage = document.getElementById('postFeedPage');
const btnBack = document.getElementById('btnBack');
const viewerStage = document.getElementById('viewerStage');
let backTarget = null;

// --- RENDER FONKSİYONLARI ---
function renderHomePage() {
  const homePage = document.getElementById('homePage');
  homePage.innerHTML = `<section class="stories"></section><section class="feed"></section>`;
  const storiesContainer = homePage.querySelector('.stories');
  const feedContainer = homePage.querySelector('.feed');

  const STORIES = getStories();
  const FEED = getFeed();

  STORIES.forEach(s => {
    const chip = document.createElement('button');
    chip.className = 'story-chip';
    chip.innerHTML = `<div class=\"story-ring\"><img class=\"story-avatar\" src=\"${s.avatar}\" alt=\"${s.name}\"></div><div class=\"story-name\">${s.name}</div>`;
    chip.onclick = () => openViewer(STORIES, s.id);
    storiesContainer.appendChild(chip);
  });

  FEED.forEach(p => {
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `<div class=\"head\"><img src=\"${p.user.avatar}\" alt=\"${p.user.username}\"><div class=\"user\">${p.user.username}</div></div><img class=\"media\" src=\"${p.post.img}\" alt=\"\"><div class=\"actions\"><span class=\"icon\">❤️</span><span class=\"icon\">💬</span><span class=\"icon\">↗️</span></div>`;
    feedContainer.appendChild(card);
  });
}

function renderProfile(userId) {
  const user = USERS_DB.find(u => u.id === userId);
  if (!user) return;
  const isMe = user.id === 'peri';

  // Başlık ve handle
  const nameEl = document.getElementById('profileName');
  const handleEl = document.getElementById('profileHandle');
  if (nameEl) nameEl.textContent = user.name;
  if (handleEl) handleEl.textContent = '@' + user.username;

  // Avatar ve story halkası
  const avatarEl = document.getElementById('profileAvatar');
  if (avatarEl) avatarEl.src = user.avatar;
  const avatarWrapper = document.getElementById('profileAvatarWrapper');
  if (avatarWrapper) {
    if (user.segments && user.segments.length > 0) {
      avatarWrapper.classList.add('has-story');
      avatarWrapper.onclick = () => openViewer([user], user.id);
    } else {
      avatarWrapper.classList.remove('has-story');
      avatarWrapper.onclick = null;
    }
  }

  // Biyografi
  const bioEl = document.getElementById('profileBio');
  if (bioEl) bioEl.textContent = user.bio || '';

  // Sayaçlar (Instagram gibi)
  const countsEl = document.getElementById('profileCounts');
  if (countsEl) countsEl.innerHTML = `<b>${user.stats.posts}</b> gönderi &nbsp;&nbsp; <b>${user.stats.followers}</b> takipçi`;

  // CTA butonları
  const btnPrimary = document.getElementById('btnPrimaryProfile');
  const btnSecondary = document.getElementById('btnSecondaryProfile');
  if (btnPrimary) {
    btnPrimary.textContent = isMe ? 'Profili düzenle' : 'Takip et';
    btnPrimary.onclick = () => alert(isMe ? 'Profil düzenleme açılacak' : `${user.name} takip edildi (demo)`);
  }
  if (btnSecondary) {
    btnSecondary.textContent = 'Mesaj';
    btnSecondary.onclick = () => alert(`${user.name} kişisine mesaj (demo)`);
  }

  // Gönderi ızgarası
  const gridContainer = document.getElementById('postGrid');
  if (gridContainer) {
    gridContainer.innerHTML = '';
    user.posts.forEach((post, index) => {
      const gridItem = document.createElement('div');
      gridItem.className = 'grid-item';
      gridItem.innerHTML = `<img src="${post.img}" alt="Gönderi ${index+1}">`;
      gridItem.onclick = () => navigateToPostFeed(user.id, index);
      gridContainer.appendChild(gridItem);
    });
  }
}

function renderSearchResults(query) {
  const normalizedQuery = query.toLowerCase().trim();
  if (normalizedQuery.length < 2) { searchResults.innerHTML = ''; return; }
  const results = USERS_DB.filter(u => (u.name.toLowerCase().includes(normalizedQuery) || u.username.toLowerCase().includes(normalizedQuery)) && u.id !== 'peri');
  searchResults.innerHTML = '';
  results.forEach(user => {
    const item = document.createElement('div');
    item.className = 'result-item';
    item.innerHTML = `<img src="${user.avatar}" alt="${user.name}"><div class="names"><div class="name">${user.name}</div><div class="muted">@${user.username}</div></div>`;
    item.onclick = () => navigateToProfile(user.id, 'searchPage');
    searchResults.appendChild(item);
  });
}

// --- HİKAYE İZLEYİCİ (RESİM & VİDEO DESTEKLİ) ---
let storyDataSource = [], currentSourceIndex = 0, currentSegmentIndex = 0, timerId = null;
function openViewer(source, startId) {
  storyDataSource = source;
  currentSourceIndex = Math.max(0, source.findIndex(s => s.id === startId));
  currentSegmentIndex = 0;
  viewer.classList.add('active');
  viewer.setAttribute('aria-hidden', 'false');
  document.documentElement.style.overflow = 'hidden';
  loadCurrentSegment();
}
function closeViewer() {
  viewer.classList.remove('active');
  viewer.setAttribute('aria-hidden', 'true');
  document.documentElement.style.overflow = '';
  clearTimer();
  const videoEl = viewerStage.querySelector('video');
  if (videoEl) videoEl.pause();
}
async function loadCurrentSegment() {
  const user = storyDataSource[currentSourceIndex];
  const segment = user?.segments?.[currentSegmentIndex];
  if (!user || !segment) { closeViewer(); return; }
  vName.textContent = user.name; vAvatar.src = user.avatar;
  renderProgress(user.segments.length, currentSegmentIndex);
  clearTimer(); viewerStage.innerHTML = '';
  const sourceUrl = segment.sources[0];
  const isImage = /\.(jpeg|jpg|png|gif|webp)$/i.test(sourceUrl);
  if (isImage) {
    const img = document.createElement('img');
    img.src = sourceUrl;
    img.className = 'story-media';
    viewerStage.appendChild(img);
    startTimer((segment.dur || 7) * 1000);
  } else {
    const video = document.createElement('video');
    video.className = 'story-media';
    video.playsInline = true; video.webkitPlaysInline = true; video.muted = true; video.preload = 'metadata';
    video.src = sourceUrl;
    video.addEventListener('ended', nextSegment);
    viewerStage.appendChild(video);
    try {
      await video.play();
      const fallbackDur = (segment.dur || 7) * 1000;
      startTimer(isFinite(video.duration) && video.duration > 0 ? video.duration * 1000 : fallbackDur);
    } catch (e) {
      nextSegment();
    }
  }
}
function renderProgress(total, activeIndex) {
  progress.innerHTML = '';
  for (let i = 0; i < total; i++) {
    const seg = document.createElement('div');
    seg.className = 'seg';
    seg.innerHTML = `<i style="width:${i < activeIndex ? 100 : 0}%"></i>`;
    progress.appendChild(seg);
  }
}
function startTimer(ms) {
  const start = performance.now();
  const segBar = progress.children[currentSegmentIndex]?.firstElementChild;
  if (!segBar || !isFinite(ms) || ms <= 0) return;
  function tick(now) {
    const pct = Math.min(100, ((now - start) / ms) * 100);
    segBar.style.width = pct + '%';
    if (pct >= 100) { nextSegment(); return; }
    timerId = requestAnimationFrame(tick);
  }
  timerId = requestAnimationFrame(tick);
}
function clearTimer() { if (timerId) cancelAnimationFrame(timerId); timerId = null; }
function nextSegment() {
  const user = storyDataSource[currentSourceIndex];
  if (currentSegmentIndex < user.segments.length - 1) { currentSegmentIndex++; loadCurrentSegment(); }
  else { nextStory(); }
}
function prevSegment() { if (currentSegmentIndex > 0) { currentSegmentIndex--; loadCurrentSegment(); } else { prevStory(); } }
function nextStory() { if (currentSourceIndex < storyDataSource.length - 1) { currentSourceIndex++; currentSegmentIndex = 0; loadCurrentSegment(); } else { closeViewer(); } }
function prevStory() { if (currentSourceIndex > 0) { currentSourceIndex--; currentSegmentIndex = 0; loadCurrentSegment(); } }
btnClose.onclick = closeViewer;
window.addEventListener('keydown', e => { if (e.key === 'Escape') closeViewer(); });

// Daha iyi dokunma desteği (tüm geniş alanlar tıklanabilir)
['click','touchend'].forEach(evt => {
  document.getElementById('tapRight').addEventListener(evt, nextSegment);
  document.getElementById('tapLeft').addEventListener(evt, prevSegment);
});

// Back butonu kontrolü
function showBack(target){ backTarget = target; if (btnBack) btnBack.classList.add('show'); }
function hideBack(){ backTarget = null; if (btnBack) btnBack.classList.remove('show'); }
if (btnBack) btnBack.onclick = () => { if (viewer.classList.contains('active')) { closeViewer(); } else if (backTarget) { showPage(backTarget); } else { goHome(); } };

// --- DİKEY GÖNDERİ AKIŞI ---
function navigateToPostFeed(userId, startIndex) {
  const user = USERS_DB.find(u => u.id === userId);
  if (!user) return;
  postFeedPage.innerHTML = '';
  user.posts.forEach((post, index) => {
    const card = document.createElement('article');
    card.className = 'card';
    card.id = `post-feed-${index}`;
    card.innerHTML = `<div class=\"head\"><img src=\"${user.avatar}\" alt=\"${user.username}\"><div class=\"user\">${user.username}</div></div><img class=\"media\" src=\"${post.img}\" alt=\"\"><div class=\"actions\"><span class=\"icon\">❤️</span><span class=\"icon\">💬</span><span class=\"icon\">↗️</span></div>`;
    postFeedPage.appendChild(card);
  });
  showBack('profilePage');
  showPage('postFeedPage');
  setTimeout(() => { document.getElementById(`post-feed-${startIndex}`).scrollIntoView({block:'start'}); }, 50);
}

// --- NAVİGASYON ---
function showPage(pageId) {
  allPages.forEach(page => page.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  let activeNav = null;
  if(pageId === 'homePage') { activeNav = navHome; brandTitle.textContent = 'Akış'; hideBack(); }
  else if(pageId === 'searchPage') { activeNav = navSearch; brandTitle.textContent = 'Arama'; hideBack(); }
  else if(pageId === 'profilePage') { activeNav = navProfile; showBack('homePage'); }
  else if(pageId === 'postFeedPage') { showBack('profilePage'); }
  if(activeNav) activeNav.classList.add('active');
}
function navigateToProfile(userId, from='homePage') {
  const user = USERS_DB.find(u => u.id === userId);
  if (!user) return;
  renderProfile(userId);
  brandTitle.textContent = user.username;
  showPage('profilePage');
  showBack(from);
}

function goHome(){ closeViewer(); renderHomePage(); showPage('homePage'); window.scrollTo({top:0, behavior:'instant'}); }
navHome.onclick = goHome;
navSearch.onclick = () => showPage('searchPage');
navProfile.onclick = () => navigateToProfile('peri', 'homePage');

let searchTimer;
if (searchInput) {
  searchInput.oninput = () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => { renderSearchResults(searchInput.value); }, 300);
  };
}

// --- SMOKE TESTS ---
(function runTests(){
  try{
    // DOM temel kontrolleri
    console.assert(document.getElementById('searchInput'), 'searchInput missing');
    console.assert(typeof getStories==='function', 'getStories missing');

    // Fatoş bio stringi: satır sonu içermemeli (malformed string hatasını önlemek için)
    const fatos = USERS_DB.find(u=>u.id==='fatosmacari');
    console.assert(typeof fatos.bio === 'string', 'Fatoş bio must be a string');
    console.assert(!/\n/.test(fatos.bio), 'Fatoş bio must not contain raw newlines');

    // Stories: Fatoş hariç, en az bir story olmalı (Selim var)
    const stories = getStories();
    console.assert(!stories.some(u=>u.id==='fatosmacari'), 'Fatoş should be excluded from stories');
    console.assert(stories.length >= 1, 'There should be at least one story');

    // Feed: Peri yok; Kadri ve Okan var
    const feed = getFeed();
    console.assert(feed.length>=1, 'Feed should not be empty');
    console.assert(feed.every(it=>it.user && it.user.id!=='peri'), 'Peri must not appear in home feed');
    const ids = feed.map(it=>it.user.id);
    console.assert(ids.includes('kadri') && ids.includes('okan'), 'Feed should include Kadri and Okan');

    // renderHomePage, kart sayısı feed uzunluğuna uymalı
    renderHomePage();
    const cards = document.querySelectorAll('#homePage .feed .card');
    console.assert(cards.length === feed.length, 'Rendered feed card count must match feed length');

    console.log('%cSmoke tests passed','color:#6ab0ff');
  }catch(e){
    console.error('Smoke tests failed', e);
  }
})();

// --- İLK YÜKLEME ---
document.addEventListener('DOMContentLoaded', () => {
  renderHomePage();
  showPage('homePage');
});
</script>
</body>
</html>
